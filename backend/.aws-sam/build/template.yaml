AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Metals + Crypto prices proxy API
Parameters:
  GoldApiKey:
    Type: String
    NoEcho: true
  RhApiKey:
    Type: String
    NoEcho: true
  RhPrivateKeyB64:
    Type: String
    NoEcho: true
  OpenaiApiKey:
    Type: String
    NoEcho: true
  ReceiptsBucketName:
    Type: String
    Default: finapp-receipts-1152
  ReceiptsPrefix:
    Type: String
    Default: receipts/
  FrontendBucketName:
    Type: String
    Default: metals-prices-sanjay-1152
  FrontendPrefix:
    Type: String
    Default: app/
Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 30
    MemorySize: 256
Resources:
  MetalsHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: $default
      CorsConfiguration:
        AllowOrigins:
        - '*'
        AllowHeaders:
        - content-type
        AllowMethods:
        - POST
        - OPTIONS
        - GET
        - PATCH
        - DELETE
      RouteSettings:
        $default:
          ThrottlingRateLimit: 10
          ThrottlingBurstLimit: 1
  PricesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PricesFunction
      Handler: handler.handler
      Environment:
        Variables:
          GOLDAPI_KEY:
            Ref: GoldApiKey
          RH_API_KEY:
            Ref: RhApiKey
          RH_PRIVATE_KEY_B64:
            Ref: RhPrivateKeyB64
      Events:
        Prices:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /prices
            Method: GET
    Metadata:
      SamResourceId: PricesFunction
  SpendingApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SpendingApiFunction
      Handler: app.handler
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          TABLE_NAME:
            Ref: CostcoSpendingTable
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: CostcoSpendingTable
      Events:
        ListSpending:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /spending
            Method: GET
        GetReceipt:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /spending/receipt/{receipt}
            Method: GET
        CreateItem:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /spending
            Method: POST
        UpdateItem:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /spending/receipt/{receipt}/line/{lineId}
            Method: PATCH
        DeleteItem:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /spending/receipt/{receipt}/line/{lineId}
            Method: DELETE
    Metadata:
      SamResourceId: SpendingApiFunction
  CostcoSpendingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: CostcoSpending
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: pk
        AttributeType: S
      - AttributeName: sk
        AttributeType: S
      - AttributeName: gsi1pk
        AttributeType: S
      - AttributeName: gsi1sk
        AttributeType: S
      KeySchema:
      - AttributeName: pk
        KeyType: HASH
      - AttributeName: sk
        KeyType: RANGE
      GlobalSecondaryIndexes:
      - IndexName: GSI1
        KeySchema:
        - AttributeName: gsi1pk
          KeyType: HASH
        - AttributeName: gsi1sk
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
  ReceiptExtractorFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs18.x
      Handler: src/handler.handler
      CodeUri: ReceiptExtractorFunction
      MemorySize: 1024
      Timeout: 60
      Environment:
        Variables:
          OPENAI_API_KEY:
            Ref: OpenaiApiKey
          COSTCO_SPENDING_TABLE:
            Ref: CostcoSpendingTable
          OPENAI_MODEL: gpt-5.2
      Policies:
      - AWSLambdaBasicExecutionRole
      - S3ReadPolicy:
          BucketName: finapp-receipts-1152
      - DynamoDBCrudPolicy:
          TableName:
            Ref: CostcoSpendingTable
    Metadata:
      SamResourceId: ReceiptExtractorFunction
  ReceiptUploadUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs18.x
      Handler: src/handler.handler
      CodeUri: ReceiptUploadUrlFunction
      MemorySize: 256
      Timeout: 15
      Environment:
        Variables:
          RECEIPTS_BUCKET:
            Ref: ReceiptsBucketName
          RECEIPTS_PREFIX:
            Ref: ReceiptsPrefix
          PRESIGN_EXPIRES_SECONDS: '300'
      Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
        - Effect: Allow
          Action:
          - s3:PutObject
          Resource:
          - Fn::Sub: arn:aws:s3:::${ReceiptsBucketName}/${ReceiptsPrefix}*
      Events:
        UploadUrlApi:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /receipts/upload-url
            Method: POST
        UploadUrlApiOptions:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /receipts/upload-url
            Method: OPTIONS
    Metadata:
      SamResourceId: ReceiptUploadUrlFunction
  FrontendProxyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FrontendProxyFunction
      Handler: src/handler.handler
      Runtime: nodejs18.x
      Timeout: 15
      MemorySize: 256
      Environment:
        Variables:
          FRONTEND_BUCKET:
            Ref: FrontendBucketName
          FRONTEND_PREFIX:
            Ref: FrontendPrefix
      Policies:
      - AWSLambdaBasicExecutionRole
      - S3ReadPolicy:
          BucketName:
            Ref: FrontendBucketName
      Events:
        AppRoot:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /app
            Method: GET
        AppProxy:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: MetalsHttpApi
            Path: /app/{proxy+}
            Method: GET
    Metadata:
      SamResourceId: FrontendProxyFunction
Outputs:
  ApiBaseUrl:
    Description: HTTP API base URL
    Value:
      Fn::Sub: https://${MetalsHttpApi}.execute-api.${AWS::Region}.amazonaws.com
  CostcoSpendingTableName:
    Description: DynamoDB table name for Costco spending items
    Value:
      Ref: CostcoSpendingTable
  CostcoSpendingTableArn:
    Description: DynamoDB table ARN
    Value:
      Fn::GetAtt:
      - CostcoSpendingTable
      - Arn
