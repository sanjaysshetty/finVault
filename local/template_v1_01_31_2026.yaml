AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: FinVault API (Prices + Spending + Receipt Processing + Curation + Analytics Export)

Parameters:
  GoldApiKey:
    Type: String
    NoEcho: true

  RhApiKey:
    Type: String
    NoEcho: true

  RhPrivateKeyB64:
    Type: String
    NoEcho: true

  OpenaiApiKey:
    Type: String
    NoEcho: true

  FinnhubApiKey:
    Type: String
    NoEcho: true

  # Existing buckets (NOT created by this stack)
  ReceiptsBucketName:
    Type: String
    Default: "finapp-receipts-1152"

  ReceiptsPrefix:
    Type: String
    Default: "receipts/"

  FrontendBucketName:
    Type: String
    Default: "metals-prices-sanjay-1152"

  FrontendPrefix:
    Type: String
    Default: "app/"

  # Cognito (domain must be unique in region)
  CognitoDomainPrefix:
    Type: String
    Default: "finvault-sanjay-1152"
    Description: "Cognito hosted UI domain prefix (must be unique per region)"

  FrontendCallbackUrlDev:
    Type: String
    Default: "http://localhost:5173/"

  FrontendCallbackUrlProd:
    Type: String
    Default: "https://example.com/app"

  # Existing Assets table name (external to this stack)
  FinAssetsTableName:
    Type: String
    Default: "finAssets"
    Description: "Existing DynamoDB table name for Assets module (this stack will not manage it)."

  # ✅ Existing ReceiptLedger table (external to this stack)
  ReceiptLedgerTableName:
    Type: String
    Default: "ReceiptLedger"
    Description: "Existing DynamoDB table name for Spending/Receipts (this stack will not create/manage it)."

  # ✅ Optional: wire DynamoDB Stream from existing ReceiptLedger -> CategoryCurator
  EnableReceiptLedgerStream:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
    Description: "Set to true only after you paste ReceiptLedger Stream ARN into ReceiptLedgerStreamArn."

  ReceiptLedgerStreamArn:
    Type: String
    Default: ""
    Description: "DynamoDB Stream ARN for the existing ReceiptLedger table (required if EnableReceiptLedgerStream=true)."

Conditions:
  CreateReceiptLedgerStreamMapping: !Equals [!Ref EnableReceiptLedgerStream, "true"]

Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 30
    MemorySize: 256

Resources:
  # -----------------------------
  # Cognito
  # -----------------------------
  FinVaultUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "finvault-userpool-${AWS::StackName}"
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 10
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: true
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      Schema:
        - Name: email
          Required: true
          Mutable: true

  FinVaultUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "finvault-spa-${AWS::StackName}"
      UserPoolId: !Ref FinVaultUserPool
      GenerateSecret: false
      AllowedOAuthFlowsUserPoolClient: true
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - openid
        - email
        - profile
      SupportedIdentityProviders:
        - COGNITO
      CallbackURLs:
        - !Ref FrontendCallbackUrlDev
        - !Ref FrontendCallbackUrlProd
      LogoutURLs:
        - !Ref FrontendCallbackUrlDev
        - !Ref FrontendCallbackUrlProd
      ExplicitAuthFlows:
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
      PreventUserExistenceErrors: ENABLED

  FinVaultUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Ref CognitoDomainPrefix
      UserPoolId: !Ref FinVaultUserPool

  FinVaultAdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: Admin
      UserPoolId: !Ref FinVaultUserPool
      Description: "Admin users"

  FinVaultPowerUserGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: PowerUser
      UserPoolId: !Ref FinVaultUserPool
      Description: "Power users"

  # -----------------------------
  # HTTP API (JWT-secured by default)
  # -----------------------------
  MetalsHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: $default
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowHeaders:
          - content-type
          - authorization
        AllowMethods:
          - GET
          - POST
          - PATCH
          - DELETE
          - OPTIONS
      RouteSettings:
        "$default":
          ThrottlingRateLimit: 10
          ThrottlingBurstLimit: 1
      Auth:
        DefaultAuthorizer: CognitoJwtAuthorizer
        Authorizers:
          CognitoJwtAuthorizer:
            JwtConfiguration:
              issuer: !Sub "https://cognito-idp.${AWS::Region}.amazonaws.com/${FinVaultUserPool}"
              audience:
                - !Ref FinVaultUserPoolClient
            IdentitySource: "$request.header.Authorization"

  # -----------------------------
  # DynamoDB tables for Curation pipeline (stack-managed)
  # -----------------------------
  ReceiptLineItemsCuratedTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "ReceiptLineItemsCurated"
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  SpendingAggregatesTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "SpendingAggregates"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  CategoryMasterTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "CategoryMaster"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  CategoryProposalsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub "CategoryProposals"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE

  FinAssetsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Ref FinAssetsTableName
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: assetId
          AttributeType: S
        - AttributeName: gsi1pk
          AttributeType: S
        - AttributeName: gsi1sk
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: assetId
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: gsi1pk
              KeyType: HASH
            - AttributeName: gsi1sk
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
  
  AnalyticsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # -----------------------------
  # Prices
  # -----------------------------
  PricesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: handler.handler
      Environment:
        Variables:
          GOLDAPI_KEY: !Ref GoldApiKey
          RH_API_KEY: !Ref RhApiKey
          RH_PRIVATE_KEY_B64: !Ref RhPrivateKeyB64
          FINNHUB_API_KEY: !Ref FinnhubApiKey
          USE_METAL_PRICE_STUB: "true"
      Events:
        Prices:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /prices
            Method: GET

  # -----------------------------
  # Spending API (reads old ReceiptLedger table)
  # -----------------------------
  SpendingApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: spending-api/
      Handler: app.handler
      Timeout: 30
      MemorySize: 256
      Environment:
        Variables:
          TABLE_NAME: !Ref ReceiptLedgerTableName
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ReceiptLedgerTableName
      Events:
        SpendingListGet:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /spending
            Method: GET
        SpendingCreatePost:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /spending
            Method: POST
        SpendingReceiptGet:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /spending/receipt/{receipt}
            Method: GET
        SpendingItemPatch:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /spending/item/{pk}/{sk}
            Method: PATCH
        SpendingItemDelete:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /spending/item/{pk}/{sk}
            Method: DELETE
        SpendingDashboardGet:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /spending/dashboard
            Method: GET

  # -----------------------------
  # Receipt extractor (writes old ReceiptLedger table)
  # -----------------------------
  ReceiptExtractorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: receipt-extractor/
      Handler: src/handler.handler
      MemorySize: 1024
      Timeout: 60
      Environment:
        Variables:
          OPENAI_API_KEY: !Ref OpenaiApiKey
          RECEIPT_LEDGER_TABLE: !Ref ReceiptLedgerTableName
          OPENAI_MODEL: "gpt-5.2"
      Policies:
        - AWSLambdaBasicExecutionRole
        - S3ReadPolicy:
            BucketName: !Ref ReceiptsBucketName
        - DynamoDBCrudPolicy:
            TableName: !Ref ReceiptLedgerTableName

  # -----------------------------
  # Receipt upload URL
  # -----------------------------
  ReceiptUploadUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: receipt-upload-url/
      Handler: src/handler.handler
      Timeout: 15
      MemorySize: 256
      Environment:
        Variables:
          RECEIPTS_BUCKET: !Ref ReceiptsBucketName
          RECEIPTS_PREFIX: !Ref ReceiptsPrefix
          PRESIGN_EXPIRES_SECONDS: "300"
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - s3:PutObject
              Resource:
                - !Sub "arn:aws:s3:::${ReceiptsBucketName}/${ReceiptsPrefix}*"
      Events:
        UploadUrlApi:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /receipts/upload-url
            Method: POST
        UploadUrlApiOptions:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /receipts/upload-url
            Method: OPTIONS

  # -----------------------------
  # Frontend proxy (PUBLIC)
  # -----------------------------
  FrontendProxyFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: frontend-proxy/
      Handler: src/handler.handler
      Timeout: 15
      MemorySize: 256
      Environment:
        Variables:
          FRONTEND_BUCKET: !Ref FrontendBucketName
          FRONTEND_PREFIX: !Ref FrontendPrefix
      Policies:
        - AWSLambdaBasicExecutionRole
        - S3ReadPolicy:
            BucketName: !Ref FrontendBucketName
      Events:
        AppRoot:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /app
            Method: GET
            Auth:
              Authorizer: NONE
        AppRootSlash:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /app/
            Method: GET
            Auth:
              Authorizer: NONE
        AppProxy:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /app/{proxy+}
            Method: GET
            Auth:
              Authorizer: NONE

  # -----------------------------
  # Shared Layer
  # -----------------------------
  FinVaultSharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub "finvault-shared-${AWS::StackName}"
      Description: Shared utilities for FinVault Lambdas
      ContentUri: layers/finvault-shared/
      CompatibleRuntimes:
        - nodejs18.x
      RetentionPolicy: Retain

  # -----------------------------
  # Category Curator Lambda (deployed)
  # -----------------------------
  CategoryCuratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "CategoryCuratorFunction-${AWS::StackName}"
      CodeUri: category-curator/
      Handler: curator.handler
      Timeout: 30
      MemorySize: 512
      Environment:
        Variables:
          CATEGORY_MASTER_TABLE: !Ref CategoryMasterTable
          CATEGORY_PROPOSALS_TABLE: !Ref CategoryProposalsTable
          CURATED_TABLE: !Ref ReceiptLineItemsCuratedTable
          AGG_TABLE: !Ref SpendingAggregatesTable
          OPENAI_API_KEY: !Ref OpenaiApiKey
          OPENAI_MODEL: "gpt-5.2"
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CategoryMasterTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoryProposalsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ReceiptLineItemsCuratedTable
        - DynamoDBCrudPolicy:
            TableName: !Ref SpendingAggregatesTable

  # ✅ Stream mapping from EXISTING ReceiptLedger -> CategoryCurator (optional, controlled by param)
  ReceiptLedgerToCuratorEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Condition: CreateReceiptLedgerStreamMapping
    Properties:
      EventSourceArn: !Ref ReceiptLedgerStreamArn
      FunctionName: !Ref CategoryCuratorFunction
      StartingPosition: TRIM_HORIZON
      BatchSize: 100
      MaximumBatchingWindowInSeconds: 2
      BisectBatchOnFunctionError: true
      Enabled: true

  # -----------------------------
  # Curated export (Curated Streams -> S3 JSONL)
  # -----------------------------
  CuratedToS3ExportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "CuratedToS3ExportFunction-${AWS::StackName}"
      CodeUri: curated-export/
      Handler: export_curated_to_s3.handler
      Timeout: 30
      MemorySize: 512
      Environment:
        Variables:
          ANALYTICS_BUCKET: !Ref AnalyticsBucket
          ANALYTICS_PREFIX: "curated_line_items"
      Policies:
        - S3WritePolicy:
            BucketName: !Ref AnalyticsBucket
      Events:
        CuratedStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt ReceiptLineItemsCuratedTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 200
            MaximumBatchingWindowInSeconds: 5
            BisectBatchOnFunctionError: true

  # -----------------------------
  # Assets API (uses existing FinAssets table name param)
  # -----------------------------
  FixedIncomeApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: assets-api/
      Handler: app.handler
      Layers:
        - !Ref FinVaultSharedLayer
      Environment:
        Variables:
          FIN_ASSETS_TABLE: !Ref FinAssetsTableName
          NODE_PATH: /opt/nodejs
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FinAssetsTableName
      Events:
        FixedIncomeList:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/fixedincome
            Method: GET
        FixedIncomeCreate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/fixedincome
            Method: POST
        FixedIncomeGet:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/fixedincome/{assetId}
            Method: GET
        FixedIncomeUpdate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/fixedincome/{assetId}
            Method: PATCH
        FixedIncomeDelete:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/fixedincome/{assetId}
            Method: DELETE
      # ===============================
      # Bullion Transactions
      # ===============================
        BullionTxList:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/bullion/transactions
            Method: GET

        BullionTxCreate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/bullion/transactions
            Method: POST

        BullionTxUpdate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/bullion/transactions/{txId}
            Method: PATCH

        BullionTxDelete:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/bullion/transactions/{txId}
            Method: DELETE


        # ===============================
        # Stock Transactions
        # ===============================
        StockTxList:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/stocks/transactions
            Method: GET

        StockTxCreate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/stocks/transactions
            Method: POST

        StockTxUpdate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/stocks/transactions/{txId}
            Method: PATCH

        StockTxDelete:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/stocks/transactions/{txId}
            Method: DELETE


        # ===============================
        # Crypto Transactions
        # ===============================
        CryptoTxList:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/crypto/transactions
            Method: GET

        CryptoTxCreate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/crypto/transactions
            Method: POST

        CryptoTxUpdate:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/crypto/transactions/{txId}
            Method: PATCH

        CryptoTxDelete:
          Type: HttpApi
          Properties:
            ApiId: !Ref MetalsHttpApi
            Path: /assets/crypto/transactions/{txId}
            Method: DELETE

Outputs:
  ApiBaseUrl:
    Description: "HTTP API base URL"
    Value: !Sub "https://${MetalsHttpApi}.execute-api.${AWS::Region}.amazonaws.com"

  AnalyticsBucketName:
    Description: "S3 analytics bucket"
    Value: !Ref AnalyticsBucket

  ReceiptLedgerTableNameOut:
    Description: "Existing raw receipt ledger table name used by this stack"
    Value: !Ref ReceiptLedgerTableName

  CuratedLineItemsTableName:
    Description: "Curated line items table name"
    Value: !Ref ReceiptLineItemsCuratedTable

  AggregatesTableName:
    Description: "Spending aggregates table name"
    Value: !Ref SpendingAggregatesTable
